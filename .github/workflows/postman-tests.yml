name: Postman Collection Validation

on:
  # Executa em push para a branch main
  push:
    branches: [ main ]
  # Executa em pull requests para a branch main
  pull_request:
    branches: [ main ]
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  validate-collection:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: Validate JSON Files
      run: |
        echo "## ðŸ§ª Postman Collection Validation" >> $GITHUB_STEP_SUMMARY
        echo "Validando arquivos JSON da coleÃ§Ã£o e ambiente..." >> $GITHUB_STEP_SUMMARY
        
        # Validar sintaxe JSON da coleÃ§Ã£o
        if jq empty "Serverest_API_Tests.postman_collection.json" 2>/dev/null; then
          echo "âœ… Collection JSON is valid" >> $GITHUB_STEP_SUMMARY
          collection_valid=true
        else
          echo "âŒ Collection JSON is invalid" >> $GITHUB_STEP_SUMMARY
          collection_valid=false
        fi
        
        # Validar sintaxe JSON do ambiente
        if jq empty "Serverest_Environment.postman_environment.json" 2>/dev/null; then
          echo "âœ… Environment JSON is valid" >> $GITHUB_STEP_SUMMARY
          environment_valid=true
        else
          echo "âŒ Environment JSON is invalid" >> $GITHUB_STEP_SUMMARY
          environment_valid=false
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Collection:** Serverest API Tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Serverest - Ambiente" >> $GITHUB_STEP_SUMMARY
        echo "- **Validation Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        
        # Verificar se ambos os arquivos sÃ£o vÃ¡lidos
        if [ "$collection_valid" = true ] && [ "$environment_valid" = true ]; then
          echo "- **Status:** âœ… All files valid" >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "- **Status:** âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
    
    - name: Check Collection Structure
      run: |
        echo "### ðŸ” Collection Analysis" >> $GITHUB_STEP_SUMMARY
        
        # Contar total de requests
        request_count=$(jq '[.item[].item[]? // .item[]] | length' "Serverest_API_Tests.postman_collection.json")
        echo "- **Total Requests:** $request_count" >> $GITHUB_STEP_SUMMARY
        
        # Verificar se existe baseUrl no ambiente
        if jq -e '.values[] | select(.key == "baseUrl")' "Serverest_Environment.postman_environment.json" > /dev/null; then
          echo "- **BaseUrl Variable:** âœ… Configured" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **BaseUrl Variable:** âŒ Missing" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Verificar se existe validaÃ§Ã£o global
        if jq -e '.event[]? | select(.listen == "prerequest")' "Serverest_API_Tests.postman_collection.json" > /dev/null; then
          echo "- **Global Pre-request Scripts:** âœ… Present" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Global Pre-request Scripts:** âŒ Missing" >> $GITHUB_STEP_SUMMARY
        fi